<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#D1D1D1">
  <title>Time Lab — PUBLICWORKS</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #D1D1D1;
      --text: #0F0F0F;
      --text-secondary: #6E6E6E;
      --accent: #0047FF;
      --alert: #FF4D00;
      --font-display: 'Space Grotesk', system-ui, sans-serif;
      --font-mono: 'IBM Plex Mono', 'SF Mono', monospace;

      /* Activity colors - muted, clinical */
      --color-past: #A8A8A8;
      --color-sleep: #4A5568;
      --color-work: #718096;
      --color-commute: #A0AEC0;
      --color-remaining: #E2E8F0;
      --color-future-sleep: #2D3748;
      --color-future-work: #4A5568;
      --color-future-commute: #718096;
      --color-future-remaining: #CBD5E0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
    }

    body {
      font-family: var(--font-mono);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    #back-link {
      position: fixed;
      top: 2rem;
      left: 2rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-decoration: none;
      z-index: 50;
      transition: color 0.15s ease;
    }

    #back-link:hover {
      color: var(--accent);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 6rem 2rem 4rem;
    }

    /* Header */
    .header {
      margin-bottom: 3rem;
    }

    .header h1 {
      font-family: var(--font-display);
      font-size: clamp(1.5rem, 4vw, 2rem);
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 0.5rem;
    }

    .header .subtitle {
      font-size: 0.875rem;
      color: var(--text-secondary);
      max-width: 50ch;
    }

    /* Tool Navigation */
    .tool-nav {
      display: flex;
      gap: 1rem;
      margin-bottom: 3rem;
      border-bottom: 1px solid var(--text);
      padding-bottom: 1rem;
    }

    .tool-nav a {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-decoration: none;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 0.5rem 0;
      transition: color 0.15s ease;
    }

    .tool-nav a:hover,
    .tool-nav a.active {
      color: var(--accent);
    }

    .tool-nav a.active {
      border-bottom: 1px solid var(--accent);
      margin-bottom: -1rem;
      padding-bottom: calc(1rem - 1px);
    }

    /* Controls */
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: rgba(0, 0, 0, 0.03);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .control-group label {
      font-size: 0.625rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-secondary);
    }

    .control-group input[type="number"] {
      font-family: var(--font-mono);
      font-size: 1rem;
      padding: 0.5rem;
      border: 1px solid var(--text);
      background: var(--bg);
      color: var(--text);
      width: 100%;
    }

    .control-group input[type="number"]:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .toggle-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      grid-column: 1 / -1;
      padding-top: 0.5rem;
    }

    .toggle-group label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .toggle {
      position: relative;
      width: 36px;
      height: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .toggle.active {
      background: var(--accent);
    }

    .toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: var(--bg);
      border-radius: 50%;
      transition: transform 0.2s ease;
    }

    .toggle.active::after {
      transform: translateX(16px);
    }

    /* Activity Legend */
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      margin-bottom: 2rem;
      padding: 1rem 0;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      opacity: 1;
      transition: opacity 0.2s ease;
    }

    .legend-item.disabled {
      opacity: 0.3;
    }

    .legend-swatch {
      width: 12px;
      height: 12px;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .legend-label {
      font-size: 0.625rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    .legend-item:hover .legend-label {
      color: var(--text);
    }

    /* Summary Stats */
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat {
      padding: 1rem;
      background: rgba(0, 0, 0, 0.03);
    }

    .stat-value {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
    }

    .stat-label {
      font-size: 0.625rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    /* Grid Container */
    .grid-container {
      position: relative;
      overflow-x: auto;
      padding-bottom: 2rem;
    }

    .grid-wrapper {
      position: relative;
      display: inline-block;
      min-width: 100%;
    }

    /* Year Labels */
    .year-labels {
      position: absolute;
      left: 0;
      top: 20px;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .year-label {
      height: 4px;
      font-size: 0.5rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      padding-right: 0.5rem;
      width: 30px;
      justify-content: flex-end;
    }

    .year-label.milestone {
      color: var(--accent);
      font-weight: 500;
    }

    /* Week Labels */
    .week-labels {
      display: flex;
      margin-left: 35px;
      margin-bottom: 4px;
    }

    .week-label {
      width: 4px;
      font-size: 0.4rem;
      color: var(--text-secondary);
      text-align: center;
    }

    /* Life Grid */
    .life-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin-left: 35px;
    }

    .year-row {
      display: flex;
      gap: 0;
      height: 4px;
    }

    .week {
      width: 4px;
      height: 4px;
      border: 0.5px solid rgba(255, 255, 255, 0.3);
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      cursor: pointer;
    }

    .week:hover {
      transform: scale(2);
      z-index: 10;
      position: relative;
      box-shadow: 0 0 0 1px var(--accent);
    }

    .week.past {
      opacity: 0.7;
    }

    .week.current {
      box-shadow: 0 0 0 2px var(--alert);
      z-index: 5;
    }

    /* Activity Classes */
    .week.sleep { background: var(--color-sleep); }
    .week.work { background: var(--color-work); }
    .week.commute { background: var(--color-commute); }
    .week.remaining { background: var(--color-remaining); }

    .week.future.sleep { background: var(--color-future-sleep); }
    .week.future.work { background: var(--color-future-work); }
    .week.future.commute { background: var(--color-future-commute); }
    .week.future.remaining { background: var(--color-future-remaining); }

    .week.hidden-activity {
      background: var(--bg) !important;
      border-color: rgba(0, 0, 0, 0.1);
    }

    /* Milestone Markers */
    .milestones {
      position: absolute;
      right: -180px;
      top: 20px;
      width: 170px;
    }

    .milestone-marker {
      position: absolute;
      left: 0;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.5rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .milestone-marker::before {
      content: '';
      width: 20px;
      height: 1px;
      background: var(--text-secondary);
      margin-top: 0.35rem;
      flex-shrink: 0;
    }

    .milestone-marker.highlight {
      color: var(--accent);
    }

    .milestone-marker.highlight::before {
      background: var(--accent);
    }

    .milestone-marker.alert {
      color: var(--alert);
    }

    .milestone-marker.alert::before {
      background: var(--alert);
    }

    /* Tooltip */
    .tooltip {
      position: fixed;
      background: var(--text);
      color: var(--bg);
      padding: 0.75rem 1rem;
      font-size: 0.75rem;
      pointer-events: none;
      z-index: 1000;
      max-width: 250px;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .tooltip.visible {
      opacity: 1;
    }

    .tooltip-title {
      font-weight: 500;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 0.5rem;
    }

    .tooltip-row {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      margin-top: 0.25rem;
    }

    .tooltip-label {
      color: rgba(255, 255, 255, 0.6);
    }

    .tooltip-value {
      font-weight: 500;
    }

    /* Footer */
    .footer {
      margin-top: 4rem;
      padding-top: 2rem;
      border-top: 1px solid var(--text);
      font-size: 0.625rem;
      color: var(--text-secondary);
    }

    .footer p {
      max-width: 60ch;
      line-height: 1.8;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .milestones {
        position: static;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 2rem;
        width: auto;
      }

      .milestone-marker {
        position: static;
      }

      .milestone-marker::before {
        display: none;
      }
    }

    @media (max-width: 600px) {
      .container {
        padding: 5rem 1rem 2rem;
      }

      #back-link {
        top: 1rem;
        left: 1rem;
      }

      .controls {
        grid-template-columns: 1fr;
      }
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <a href="../../" id="back-link">&larr; PUBLICWORKS</a>

  <div class="container">
    <header class="header">
      <h1>Time Lab</h1>
      <p class="subtitle">Tools for visualizing and understanding the structure of time.</p>
    </header>

    <nav class="tool-nav">
      <a href="#" class="active">Life Visualizer</a>
    </nav>

    <!-- Controls -->
    <div class="controls">
      <div class="control-group">
        <label for="current-age">Current Age</label>
        <input type="number" id="current-age" min="0" max="120" value="30">
      </div>
      <div class="control-group">
        <label for="lifespan">Expected Lifespan</label>
        <input type="number" id="lifespan" min="1" max="120" value="80">
      </div>
      <div class="control-group">
        <label for="work-hours">Work Hours / Week</label>
        <input type="number" id="work-hours" min="0" max="168" value="40">
      </div>
      <div class="control-group">
        <label for="commute-hours">Commute Hours / Week</label>
        <input type="number" id="commute-hours" min="0" max="168" value="5">
      </div>
      <div class="control-group">
        <label for="sleep-hours">Sleep Hours / Night</label>
        <input type="number" id="sleep-hours" min="0" max="24" value="7">
      </div>
      <div class="toggle-group">
        <div class="toggle" id="use-averages" role="switch" aria-checked="false" tabindex="0"></div>
        <label for="use-averages">Use population averages</label>
      </div>
    </div>

    <!-- Legend -->
    <div class="legend">
      <div class="legend-item" data-activity="sleep">
        <div class="legend-swatch" style="background: var(--color-future-sleep);"></div>
        <span class="legend-label">Sleep</span>
      </div>
      <div class="legend-item" data-activity="work">
        <div class="legend-swatch" style="background: var(--color-future-work);"></div>
        <span class="legend-label">Work</span>
      </div>
      <div class="legend-item" data-activity="commute">
        <div class="legend-swatch" style="background: var(--color-future-commute);"></div>
        <span class="legend-label">Commute</span>
      </div>
      <div class="legend-item" data-activity="remaining">
        <div class="legend-swatch" style="background: var(--color-future-remaining);"></div>
        <span class="legend-label">Remaining</span>
      </div>
    </div>

    <!-- Summary Stats -->
    <div class="summary">
      <div class="stat">
        <div class="stat-value" id="stat-total-weeks">0</div>
        <div class="stat-label">Total Weeks</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-weeks-lived">0</div>
        <div class="stat-label">Weeks Lived</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-weeks-remaining">0</div>
        <div class="stat-label">Weeks Remaining</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-sleep-years">0</div>
        <div class="stat-label">Years Sleeping</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-work-years">0</div>
        <div class="stat-label">Years Working</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-free-years">0</div>
        <div class="stat-label">Years Free</div>
      </div>
    </div>

    <!-- Grid -->
    <div class="grid-container">
      <div class="grid-wrapper">
        <div class="week-labels" id="week-labels"></div>
        <div class="year-labels" id="year-labels"></div>
        <div class="life-grid" id="life-grid"></div>
        <div class="milestones" id="milestones"></div>
      </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip">
      <div class="tooltip-title">Week 1,560</div>
      <div class="tooltip-row">
        <span class="tooltip-label">Age</span>
        <span class="tooltip-value">30 years</span>
      </div>
    </div>

    <footer class="footer">
      <p>Your life in weeks. Each square represents one week. The grid visualizes how major activities accumulate over a lifetime. This is not a productivity tool. It is observational.</p>
    </footer>
  </div>

  <script>
    (function() {
      'use strict';

      // ---------- Population Averages ----------
      const AVERAGES = {
        workHours: 40,
        commuteHours: 4.5,
        sleepHours: 7,
        lifespan: 79
      };

      // ---------- Life Milestones (US averages) ----------
      const MILESTONES = [
        { age: 5, label: 'Start kindergarten', type: 'normal' },
        { age: 13, label: 'Become a teenager', type: 'normal' },
        { age: 16, label: 'Can drive in most states', type: 'normal' },
        { age: 18, label: 'Legal adult', type: 'highlight' },
        { age: 21, label: 'Can drink legally', type: 'normal' },
        { age: 22, label: 'College graduation (avg)', type: 'normal' },
        { age: 26, label: 'Average first child (women)', type: 'normal' },
        { age: 30, label: 'Average first marriage (men)', type: 'normal' },
        { age: 35, label: 'Peak earning potential begins', type: 'normal' },
        { age: 40, label: 'Midlife', type: 'highlight' },
        { age: 50, label: 'Average grandparent age', type: 'normal' },
        { age: 62, label: 'Early Social Security eligible', type: 'normal' },
        { age: 65, label: 'Medicare eligible', type: 'highlight' },
        { age: 67, label: 'Full retirement age', type: 'highlight' },
        { age: 73, label: 'Average US male life expectancy', type: 'alert' },
        { age: 79, label: 'Average US female life expectancy', type: 'alert' },
        { age: 85, label: 'Average nursing home admission', type: 'normal' },
      ];

      // ---------- State ----------
      let state = {
        currentAge: 30,
        lifespan: 80,
        workHours: 40,
        commuteHours: 5,
        sleepHours: 7,
        useAverages: false,
        hiddenActivities: new Set()
      };

      // ---------- DOM Elements ----------
      const inputs = {
        currentAge: document.getElementById('current-age'),
        lifespan: document.getElementById('lifespan'),
        workHours: document.getElementById('work-hours'),
        commuteHours: document.getElementById('commute-hours'),
        sleepHours: document.getElementById('sleep-hours'),
        useAverages: document.getElementById('use-averages')
      };

      const stats = {
        totalWeeks: document.getElementById('stat-total-weeks'),
        weeksLived: document.getElementById('stat-weeks-lived'),
        weeksRemaining: document.getElementById('stat-weeks-remaining'),
        sleepYears: document.getElementById('stat-sleep-years'),
        workYears: document.getElementById('stat-work-years'),
        freeYears: document.getElementById('stat-free-years')
      };

      const grid = document.getElementById('life-grid');
      const weekLabels = document.getElementById('week-labels');
      const yearLabels = document.getElementById('year-labels');
      const milestonesContainer = document.getElementById('milestones');
      const tooltip = document.getElementById('tooltip');
      const legendItems = document.querySelectorAll('.legend-item');

      // ---------- Calculations ----------
      function calculateActivityHours() {
        const hoursPerWeek = 168;
        const sleepHoursPerWeek = state.sleepHours * 7;

        // Work hours only count for working years (roughly 22-67)
        const workingYears = Math.max(0, Math.min(state.lifespan, 67) - 22);
        const retiredYears = Math.max(0, state.lifespan - 67);
        const youngYears = Math.min(22, state.lifespan);

        return {
          sleep: sleepHoursPerWeek / hoursPerWeek,
          work: state.workHours / hoursPerWeek,
          commute: state.commuteHours / hoursPerWeek,
          remaining: 1 - (sleepHoursPerWeek + state.workHours + state.commuteHours) / hoursPerWeek,
          workingYears,
          retiredYears,
          youngYears
        };
      }

      function getWeekActivity(weekNumber, totalWeeks, ratios) {
        const year = Math.floor(weekNumber / 52);
        const isWorkingAge = year >= 22 && year < 67;

        // Calculate which portion of the week this falls into
        const weekPosition = (weekNumber % 52) / 52;

        // Time allocation within each week (simplified linear model)
        let accumulated = 0;

        accumulated += ratios.sleep;
        if (weekPosition < ratios.sleep) return 'sleep';

        if (isWorkingAge) {
          accumulated += ratios.work;
          if (weekPosition < accumulated) return 'work';

          accumulated += ratios.commute;
          if (weekPosition < accumulated) return 'commute';
        }

        return 'remaining';
      }

      function updateStats() {
        const totalWeeks = state.lifespan * 52;
        const weeksLived = state.currentAge * 52;
        const weeksRemaining = Math.max(0, totalWeeks - weeksLived);

        const ratios = calculateActivityHours();

        // Calculate lifetime hours for each activity
        const totalHours = state.lifespan * 52 * 168;
        const sleepHours = state.sleepHours * 7 * 52 * state.lifespan;
        const workHours = state.workHours * 52 * ratios.workingYears;
        const commuteHours = state.commuteHours * 52 * ratios.workingYears;
        const freeHours = totalHours - sleepHours - workHours - commuteHours;

        stats.totalWeeks.textContent = totalWeeks.toLocaleString();
        stats.weeksLived.textContent = weeksLived.toLocaleString();
        stats.weeksRemaining.textContent = weeksRemaining.toLocaleString();
        stats.sleepYears.textContent = (sleepHours / (24 * 365)).toFixed(1);
        stats.workYears.textContent = (workHours / (24 * 365)).toFixed(1);
        stats.freeYears.textContent = (freeHours / (24 * 365)).toFixed(1);
      }

      // ---------- Grid Rendering ----------
      function renderGrid() {
        grid.innerHTML = '';
        yearLabels.innerHTML = '';
        weekLabels.innerHTML = '';

        const totalWeeks = state.lifespan * 52;
        const weeksLived = state.currentAge * 52;
        const ratios = calculateActivityHours();

        // Week labels (every 10 weeks)
        for (let w = 1; w <= 52; w++) {
          const label = document.createElement('div');
          label.className = 'week-label';
          label.textContent = w % 10 === 0 ? w : '';
          weekLabels.appendChild(label);
        }

        // Year rows
        for (let year = 0; year < state.lifespan; year++) {
          // Year label
          const yearLabel = document.createElement('div');
          yearLabel.className = 'year-label';
          if (year % 5 === 0 || year === state.currentAge) {
            yearLabel.textContent = year;
          }
          if (year === state.currentAge) {
            yearLabel.classList.add('milestone');
          }
          yearLabels.appendChild(yearLabel);

          // Week row
          const row = document.createElement('div');
          row.className = 'year-row';

          for (let week = 0; week < 52; week++) {
            const weekNumber = year * 52 + week;
            const weekEl = document.createElement('div');
            weekEl.className = 'week';

            const activity = getWeekActivity(weekNumber, totalWeeks, ratios);
            weekEl.classList.add(activity);

            if (weekNumber < weeksLived) {
              weekEl.classList.add('past');
            } else {
              weekEl.classList.add('future');
            }

            if (weekNumber === weeksLived) {
              weekEl.classList.add('current');
            }

            if (state.hiddenActivities.has(activity)) {
              weekEl.classList.add('hidden-activity');
            }

            weekEl.dataset.week = weekNumber;
            weekEl.dataset.year = year;
            weekEl.dataset.activity = activity;

            row.appendChild(weekEl);
          }

          grid.appendChild(row);
        }

        renderMilestones();
      }

      function renderMilestones() {
        milestonesContainer.innerHTML = '';

        const rowHeight = 4; // matches .year-row height

        MILESTONES.forEach(milestone => {
          if (milestone.age > state.lifespan) return;

          const marker = document.createElement('div');
          marker.className = `milestone-marker ${milestone.type}`;
          marker.style.top = `${milestone.age * rowHeight}px`;
          marker.innerHTML = `<span>${milestone.label}</span>`;

          milestonesContainer.appendChild(marker);
        });
      }

      // ---------- Tooltip ----------
      function showTooltip(e, weekEl) {
        const weekNumber = parseInt(weekEl.dataset.week);
        const year = parseInt(weekEl.dataset.year);
        const activity = weekEl.dataset.activity;
        const isPast = weekEl.classList.contains('past');

        const weeksLived = state.currentAge * 52;
        const totalWeeks = state.lifespan * 52;

        const ratios = calculateActivityHours();
        const activityPercent = (ratios[activity] * 100).toFixed(1);

        // Calculate totals for this activity up to this point
        const isWorkingAge = year >= 22 && year < 67;
        let activityWeeks = 0;

        for (let w = 0; w <= weekNumber; w++) {
          const a = getWeekActivity(w, totalWeeks, ratios);
          if (a === activity) activityWeeks++;
        }

        const activityYears = (activityWeeks / 52).toFixed(1);
        const lifePercent = ((activityWeeks / (weekNumber + 1)) * 100).toFixed(1);

        const activityLabels = {
          sleep: 'Sleep',
          work: 'Work',
          commute: 'Commute',
          remaining: 'Free Time'
        };

        tooltip.innerHTML = `
          <div class="tooltip-title">Week ${(weekNumber + 1).toLocaleString()} — Age ${year}</div>
          <div class="tooltip-row">
            <span class="tooltip-label">Status</span>
            <span class="tooltip-value">${isPast ? 'Lived' : 'Future'}</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Activity</span>
            <span class="tooltip-value">${activityLabels[activity]}</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Total ${activityLabels[activity]}</span>
            <span class="tooltip-value">${activityWeeks.toLocaleString()} weeks (${activityYears} yrs)</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">% of time so far</span>
            <span class="tooltip-value">${lifePercent}%</span>
          </div>
        `;

        tooltip.classList.add('visible');
        positionTooltip(e);
      }

      function positionTooltip(e) {
        const padding = 15;
        let x = e.clientX + padding;
        let y = e.clientY + padding;

        const rect = tooltip.getBoundingClientRect();

        if (x + rect.width > window.innerWidth) {
          x = e.clientX - rect.width - padding;
        }

        if (y + rect.height > window.innerHeight) {
          y = e.clientY - rect.height - padding;
        }

        tooltip.style.left = `${x}px`;
        tooltip.style.top = `${y}px`;
      }

      function hideTooltip() {
        tooltip.classList.remove('visible');
      }

      // ---------- Event Handlers ----------
      function handleInputChange() {
        state.currentAge = Math.max(0, Math.min(120, parseInt(inputs.currentAge.value) || 0));
        state.lifespan = Math.max(1, Math.min(120, parseInt(inputs.lifespan.value) || 80));
        state.workHours = Math.max(0, Math.min(168, parseInt(inputs.workHours.value) || 0));
        state.commuteHours = Math.max(0, Math.min(168, parseInt(inputs.commuteHours.value) || 0));
        state.sleepHours = Math.max(0, Math.min(24, parseInt(inputs.sleepHours.value) || 0));

        // Ensure lifespan >= current age
        if (state.lifespan < state.currentAge) {
          state.lifespan = state.currentAge;
          inputs.lifespan.value = state.lifespan;
        }

        updateStats();
        renderGrid();
      }

      function handleAveragesToggle() {
        state.useAverages = !state.useAverages;
        inputs.useAverages.classList.toggle('active', state.useAverages);
        inputs.useAverages.setAttribute('aria-checked', state.useAverages);

        if (state.useAverages) {
          inputs.workHours.value = AVERAGES.workHours;
          inputs.commuteHours.value = AVERAGES.commuteHours;
          inputs.sleepHours.value = AVERAGES.sleepHours;
          inputs.lifespan.value = AVERAGES.lifespan;

          inputs.workHours.disabled = true;
          inputs.commuteHours.disabled = true;
          inputs.sleepHours.disabled = true;
          inputs.lifespan.disabled = true;
        } else {
          inputs.workHours.disabled = false;
          inputs.commuteHours.disabled = false;
          inputs.sleepHours.disabled = false;
          inputs.lifespan.disabled = false;
        }

        handleInputChange();
      }

      function handleLegendClick(e) {
        const item = e.currentTarget;
        const activity = item.dataset.activity;

        if (state.hiddenActivities.has(activity)) {
          state.hiddenActivities.delete(activity);
          item.classList.remove('disabled');
        } else {
          state.hiddenActivities.add(activity);
          item.classList.add('disabled');
        }

        // Update grid visibility
        document.querySelectorAll(`.week[data-activity="${activity}"]`).forEach(el => {
          el.classList.toggle('hidden-activity', state.hiddenActivities.has(activity));
        });
      }

      function handleGridHover(e) {
        const weekEl = e.target.closest('.week');
        if (weekEl) {
          showTooltip(e, weekEl);
        }
      }

      function handleGridLeave() {
        hideTooltip();
      }

      // ---------- Initialize ----------
      function init() {
        // Input listeners
        Object.values(inputs).forEach(input => {
          if (input.type === 'number') {
            input.addEventListener('input', handleInputChange);
          }
        });

        inputs.useAverages.addEventListener('click', handleAveragesToggle);
        inputs.useAverages.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handleAveragesToggle();
          }
        });

        // Legend listeners
        legendItems.forEach(item => {
          item.addEventListener('click', handleLegendClick);
        });

        // Grid listeners
        grid.addEventListener('mousemove', handleGridHover);
        grid.addEventListener('mouseleave', handleGridLeave);

        // Initial render
        updateStats();
        renderGrid();
      }

      init();
    })();
  </script>
</body>
</html>
